<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script>
			const electron = require('electron');
			const { ipcRenderer } = electron;
			const WebSocket = require('ws');

			const { 
				initializeDB,
				syncTransactions,
				getInfo,
				insertItem,
				deleteItem,
				updateConfigs,
				getConfigs
			} = require('./src/background/manageDB');

			const { startWatch } = require('./src/background/watch');

			var socket;

			const message2UI = (command, payload) => {
				ipcRenderer.send('message-from-worker', {
					command: command, payload: payload
				});
			}

			const error = (message) => {
				ipcRenderer.send('background-error', { message });
			}

			const updateInfo = async (db) => {
				message2UI('set-loading', {value: true});
				
				const address = localStorage.getItem('address');
				if (!address) {
					return;
				}

				await syncTransactions(db, address);
				getInfo(db, address)
					.then((info) => {
						message2UI('update-info', { 
							info
						});
					});
			}

			const handleMessageFromMain = (_, arg) => {
				const command = arg.command;
				const payload = arg.payload;

				initializeDB()
					.then(db => {
						switch (command) {
							case 'update-info':

								updateInfo(db);
								break;

							case 'insert-item':
								const { 
									id, name, price, description, barcode, category, extra
								} = payload;

								insertItem(
									db, id, name, description, barcode, category, price, extra);
								updateInfo(db);
								break;

							case 'delete-item':
								const dId = payload.id;

								deleteItem(db, dId);
								updateInfo(db);
								break;

							case 'watch':

								getConfigs(db)
									.then(configs => {
										const address = configs.address;
										const server = configs.wssServer;

										// Setup WebSocket
										socket = new WebSocket(server);

										startWatch(db, socket, (data) => {
											if (data.success) {
												message2UI('receive-transaction', {
													amount: data.amount / Math.pow(10, 30)
												});
											} else {
												error(message);
											}
										});

										ipcRenderer.removeListener(
											'message-from-main', handleMessageFromMain);
									})
									.catch(err => {
										error(err);

										ipcRenderer.removeListener(
											'message-from-main', handleMessageFromMain);
									});
								break;
							
							case 'stop-watch':

								console.log('beep');
								socket.terminate();
								break;

							case 'save-changes':
								const { changes } = payload;

								updateConfigs(db, changes);
							
								break;

							default:
								console.log('Hidden: Command not found!');
						}
					})
					.catch((err) => {
						console.log(err);
					});
			}

			ipcRenderer.on('message-from-main', (_, arg) => {
				handleMessageFromMain(_, arg);
			});
		</script>
  </body>
</html>